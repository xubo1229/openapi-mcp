# Default specs directory
SPEC_DIR ?= ./openapi-file

# Build directory
BUILD_DIR ?= ./bin

# Binary name (without extension)
BINARY_NAME ?= openapi-mcp-qihoo

.PHONY: build build-mac build-windows build-linux build-with-ext clean all

############################################################
all: clean build-mac build-windows build-linux
	@echo "All builds complete"
############################################################

# Target platforms
PLATFORMS := darwin windows linux
ARCH := amd64

# ---------------- Build ----------------
build:
	@echo "Building with specs from: $(SPEC_DIR)"
	@mkdir -p $(BUILD_DIR)
	# Copy specs to the expected directory before building
	rm -rf ./cmd/openapi-mcp-no-file-argument/specs
	cp -r $(SPEC_DIR) ./cmd/openapi-mcp-no-file-argument/specs
	go build -o $(BUILD_DIR)/$(BINARY_NAME) ./cmd/openapi-mcp-no-file-argument
	@echo "Build complete: $(BUILD_DIR)/$(BINARY_NAME)"

# ---------------- Build for specific platform ----------------
build-mac:
	@echo "Building for darwin/$(ARCH) with specs from: $(SPEC_DIR)"
	@mkdir -p $(BUILD_DIR)
	rm -rf ./cmd/openapi-mcp-no-file-argument/specs
	cp -r $(SPEC_DIR) ./cmd/openapi-mcp-no-file-argument/specs
	GOOS=darwin GOARCH=$(ARCH) go build -o $(BUILD_DIR)/$(BINARY_NAME)-mac ./cmd/openapi-mcp-no-file-argument
	@echo "Build complete: $(BUILD_DIR)/$(BINARY_NAME)-mac"

build-windows:
	@echo "Building for windows/$(ARCH) with specs from: $(SPEC_DIR)"
	@mkdir -p $(BUILD_DIR)
	rm -rf ./cmd/openapi-mcp-no-file-argument/specs
	cp -r $(SPEC_DIR) ./cmd/openapi-mcp-no-file-argument/specs
	GOOS=windows GOARCH=$(ARCH) go build -o $(BUILD_DIR)/$(BINARY_NAME)-windows.exe ./cmd/openapi-mcp-no-file-argument
	@echo "Build complete: $(BUILD_DIR)/$(BINARY_NAME)-windows.exe"

build-linux:
	@echo "Building for linux/$(ARCH) with specs from: $(SPEC_DIR)"
	@mkdir -p $(BUILD_DIR)
	rm -rf ./cmd/openapi-mcp-no-file-argument/specs
	cp -r $(SPEC_DIR) ./cmd/openapi-mcp-no-file-argument/specs
	GOOS=linux GOARCH=$(ARCH) go build -o $(BUILD_DIR)/$(BINARY_NAME)-linux ./cmd/openapi-mcp-no-file-argument
	@echo "Build complete: $(BUILD_DIR)/$(BINARY_NAME)-linux"



# ---------------- Clean ----------------
clean:
	rm -f $(BUILD_DIR)/$(BINARY_NAME)*
	rm -rf ./cmd/openapi-mcp-no-file-argument/specs
	@echo "Clean complete"


